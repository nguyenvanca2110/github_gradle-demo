=================== Azure ========================
# Login to Azure

az login

export RESOURCE_GROUP='gradle-demo'
export AKS_CLUSTER='gradle-cluster'
export ACR_LSE_POC='gradledemoacr'
export ACR_LSE_POC_URL='gradledemoacr.azurecr.io'

echo $RESOURCE_GROUP
echo $AKS_CLUSTER
echo $AKS_NAMESPACE
echo $ACR_LSE_POC
echo $ACR_LSE_POC_URL
=================== Azure AKS ========================

#  Get the credentials of AKS in local to mange the AKS Cluster 
az aks get-credentials --resource-group=<RGNAME> --name=<AKSCLUSTERNAME>

az aks get-credentials --resource-group=$RESOURCE_GROUP --name=$AKS_CLUSTER --overwrite-existing

#  Get all AKS namespace 
kubectl get all --all-namespaces -o wide

#  Creat a new namespace
kubectl create -f ./new-namespace.yaml

# List all pods in ps output format
kubectl get pods

# List all pods in ps output format with more information (such as node name)
kubectl get pods -o wide

kubectl get nodes

# List all services using in the Cluster 
kubectl get services 

=================== Azure ACR ========================

# List repositories in a given Azure Container Registry.
# az acr repository list --name MyRegistry
az acr repository list --name $ACR_LSE_POC

# List container registries in a resource group and show the results in a table.
az acr list --resource-group $RESOURCE_GROUP --output table

# List repositories in an Azure Container Registry. (autogenerated)
# az acr repository list --name MyRegistry --resource-group myresourcegroup
az acr repository list --name $ACR_LSE_POC --resource-group $RESOURCE_GROUP

# For deploying Docker images from ACR into AKS clusters
# We need to make an authentication between AKS and ACR to AKS can PULL an image from ACR
az aks update --resource-group $RESOURCE_GROUP --name $AKS_CLUSTER --attach-acr $ACR_LSE_POC

# Import the image from the registries to AKS 
az acr import –name canv-app –source mcr.microsoft.com/azuredocs/azure-vote-front:v2 –image azure-vote-front:v2

=================== DOCKER ========================
# login to ACR Registries for push image
docker login <REGISTRY_NAME>.azurecr.io -u <appId> -p <password>

docker login $ACR_LSE_POC_URL -u $POC_ACR_CREDENTIALS_USR -p $POC_ACR_CREDENTIALS_PSW

# Push image to ACR:
docker push $ACR_LSE_POC_URL/nodeapp_app:$BUILD_NUMBER

================================================
# Store credential for AKS, the secret 'lsepocnodejs-secret' will be used to pull the image
# Because we can have multiple Registries
 
kubectl create secret docker-registry <secret-name> --namespace <namespace> --docker-server=<REGISTRY_NAME>.azurecr.io --docker-username=<appId> --docker-password=<password>
 
kubectl create secret docker-registry lsepocnodejs-secret --namespace canv-aks-demo9138 --docker-server canvnodejsapp.azurecr.io --docker-username=$POC_ACR_CREDENTIALS_USR --docker-password=$POC_ACR_CREDENTIALS_PSW

 

# ======= Deploy to AKS and Test

# make 
kubectl apply -f kube-manifests/

# List Pods
kubectl get pods

# Describe Pod
kubectl describe pod <pod-name>

# Get Load Balancer IP
kubectl get svc

# Access Application
http://<External-IP-from-get-service-output>

















# =====================================================================================
 # Export Command
export ACR_REGISTRY=canvnodejsapp.azurecr.io
export ACR_NAMESPACE=canv-aks-demo9138
export ACR_IMAGE_NAME=kube-nginx-acr
export ACR_IMAGE_TAG=v1
echo $ACR_REGISTRY, $ACR_NAMESPACE, $ACR_IMAGE_NAME, $ACR_IMAGE_TAG

# Login to ACR
docker login $ACR_REGISTRY


=== Configure ACR integration for existing AKS clusters¶

#Set ACR NAME
export ACR_NAME=canv-aks-demo9138
echo $ACR_NAME

# Template
az aks update -n myAKSCluster -g myResourceGroup --attach-acr <acr-name>

# Replace Cluster, Resource Group and ACR Repo Name
az aks update -n aksdemo2 -g aks-rg2 --attach-acr $ACR_NAME



===================== Azure AKS Credential ===========